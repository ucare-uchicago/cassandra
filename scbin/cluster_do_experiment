#!/bin/sh

cwd=`pwd`
scriptdir=`dirname $0`
cd $scriptdir
scriptdir=`pwd`
cd $cwd

. $scriptdir/readconfig
. $scriptdir/ipman

cd $scriptdir

if ! [ -f $scriptdir/scdeploy.conf.exp ]; then
  echo There is no $scriptdir/scdeploy.conf.exp ...
  echo scdeploy.conf.exp is a scdeploy.conf without cassandra_data_dir assigned
  exit 1
fi

if [ -z "$test_size" ]; then
  test_size="2 16"
fi

for n in $test_size; do
  echo Testing $n physical machines
  ./gen_nmc_machinelist $n
  cp scdeploy.conf.exp scdeploy.conf.$n
  echo "cassandra_log_dir=$cassandra_log_dir/n$n" >> scdeploy.conf.$n
  echo "cassandra_data_dir=$cassandra_data_dir/n$n" >> scdeploy.conf.$n
  ./cluster_dir_setup scdeploy.conf.$n
  ./cluster_start scdeploy.conf.$n
  sleep 60
  ../bin/cassandra-cli --host 192.168.1.1 -f /users/riza/sclck/data
  sleep 30
  ../bin/nodetool --host 192.168.${n}.1 decommission
  sleep 300
  ./cluster_stop scdeploy.conf.$n
  ./cluster_collect_logdir scdeploy.conf.$n
done

